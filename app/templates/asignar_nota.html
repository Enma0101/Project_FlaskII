<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignar Notas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='notas.css') }}">
</head>
<body>
    <div class="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <h1>Asignar Notas</h1>
    <form id="nota-form" action="/asignar_nota" method="POST">
        <div>
            <label for="categoria">Categoría:</label>
            <select id="categoria" name="categoria" required>
                <option value="">Selecciona una categoría</option>
                {% for categoria in categorias %}
                    <option value="{{ categoria.id_categoria }}">{{ categoria.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="id_curso">Curso:</label>
            <select id="id_curso" name="id_curso" required>
                <option value="" disabled selected>Seleccione un curso</option>
            </select>
        </div>
        <div>
            <label for="dni_estudiante">DNI Estudiante:</label>
            <input type="text" id="dni_estudiante" name="dni_estudiante" required autofocus>
        </div>
        <div>
            <label for="dni_estudiante_display">Estudiante:</label>
            <input type="text" id="dni_estudiante_display" name="nombre_estudiante" readonly>
        </div>
        <div>
            <label for="campo-notas">Nota:</label>
            <input type="number" id="campo-notas" name="nota" required>
            <button type="submit" class="btn">Agregar nota</button>
            <a href="{{ url_for('index') }}" class="button button-back">Back</a>
        </div>
    </form>

    <script>
            //Categorias
            document.getElementById('categoria').addEventListener('change', function() {
                var categoriaId = this.value;
                console.log(`Fetching courses for category ID: ${categoriaId}`);
                fetch(`/get_courses/${categoriaId}`)
                    .then(response => response.json())
                    .then(data => {
                        var cursoSelect = document.getElementById('id_curso');
                        cursoSelect.innerHTML = '<option value="" disabled selected>Seleccione un curso</option>';
                        data.forEach(curso => {
                            var option = document.createElement('option');
                            option.value = curso.id_curso;
                            option.textContent = curso.nombre_curso;
                            cursoSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching courses:', error));
            });

            document.getElementById('id_curso').addEventListener('change', function() {
                var cursoId = this.value;
                fetch(`/get_students/${cursoId}`)
                    .then(response => response.json())
                    .then(data => {
                        var estudianteSelect = document.getElementById('dni_estudiante');
                        estudianteSelect.innerHTML = '';
                        data.forEach(estudiante => {
                            var option = document.createElement('option');
                            option.value = estudiante.dni_estudiante;
                            option.textContent = `${estudiante.nombre} ${estudiante.apellido}`;
                            estudianteSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching students:', error));
            });

            document.getElementById('dni_estudiante').addEventListener('input', function() {
                var dniEstudiante = this.value.trim();
                if (dniEstudiante) {
                    fetch(`/get_student_name_by_dni/${dniEstudiante}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.nombre_completo) {
                                document.getElementById('dni_estudiante_display').value = data.nombre_completo;
                            } else {
                                document.getElementById('dni_estudiante_display').value = 'Estudiante no encontrado';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching student name:', error);
                        });
                } else {
                    document.getElementById('dni_estudiante_display').value = '';
                }
            });

            document.getElementById('campo-notas').addEventListener('input', function() {
                var nota = parseFloat(this.value);
                if (nota < 0 || nota > 20 || isNaN(nota)) {
                    this.setCustomValidity('La nota debe estar entre 0 y 20');
                } else {
                    this.setCustomValidity('');
                }
            });
    </script>
</body>
</html>

